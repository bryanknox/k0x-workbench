name: ci

on:
  workflow_dispatch:
  pull_request:
    paths:
      - 'src/**'
      - 'tests/**'
  push:
    branches: ["*"]
    paths:
      - 'src/**'
      - 'tests/**'

env:
  CONFIGURATION: Release

jobs:

  build_and_test:
    name: Build and Test

    runs-on: windows-latest

    steps:

      - name: 🤘 Checkout repository
        uses: actions/checkout@v3

      - name: 🔧 Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '9.0.x'

      - name: 🔄 dotnet restore (WpfBlazor only)
        shell: pwsh
        run: |
          dotnet restore `
            src/WpfBlazor/WpfBlazor.csproj

      - name: 🙏 dotnet build (WpfBlazor only)
        shell: pwsh
        run: |
          dotnet build `
            src/WpfBlazor/WpfBlazor.csproj `
            --configuration $env:CONFIGURATION `
            --no-restore

      - name: 🔄 dotnet restore (each .csproj in tests)
        shell: pwsh
        run: |
          Get-ChildItem -Path tests -Recurse -Filter *.csproj |
            ForEach-Object {
              Write-Host "🔄 Restoring $($_.FullName)"
              dotnet restore `
                $_.FullName
            }

      - name: 🙏 dotnet build (each .csproj in tests)
        shell: pwsh
        run: |
          Get-ChildItem -Path tests -Recurse -Filter *.csproj |
            ForEach-Object {
              Write-Host "🙏 Building $($_.FullName)"
              dotnet build `
                $_.FullName `
                --configuration $env:CONFIGURATION `
                --no-restore
            }

      - name: 🧪 dotnet test (each .csproj in tests)
        shell: pwsh
        run: |
          Get-ChildItem -Path tests -Recurse -Filter *.csproj |
            ForEach-Object {
              Write-Host "🧪 Running tests for $($_.FullName)"
              dotnet test `
                $_.FullName `
                --configuration $env:CONFIGURATION `
                --no-build
            }
